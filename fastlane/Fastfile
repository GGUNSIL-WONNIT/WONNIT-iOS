default_platform(:ios)

lane :set_build_number_from_git do
  build_number = `git rev-list --count HEAD`.strip
  UI.message("Setting build number to #{build_number}")
  increment_build_number(
    build_number: build_number
  )
end

platform :ios do
  desc "Deploy to TestFlight Internal"
  lane :beta do
    sh("bundle exec pod install --repo-update")

    sh %(
      xcodebuild -resolvePackageDependencies \
        -workspace WONNIT.xcworkspace \
        -scheme WONNIT
    )

    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
      is_key_content_base64: true
    )

    setup_ci(force: true)

    match(
      type: "appstore",
      readonly: true,
      api_key: lane_context[SharedValues::APP_STORE_CONNECT_API_KEY]
    )

    build_app(
      workspace: "WONNIT.xcworkspace",
      scheme: "WONNIT",
      export_method: "app-store"
    )

    upload_to_testflight(
      api_key: lane_context[SharedValues::APP_STORE_CONNECT_API_KEY],
      skip_waiting_for_build_processing: true
    )
  end
end

